Fixed bugs and added missing functionality from stage 3
